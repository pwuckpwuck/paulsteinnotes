<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Paul Stein Notes </title>

  <!-- PapaParse -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

  <style>
    body {
      font-family: system-ui, sans-serif;
      margin: 0;
      display: grid;
      grid-template-columns: 240px 1fr;
      height: 100vh;
    }

    /* Sidebar */
    aside {
      background: #f7f7f7;
      padding: 20px;
      border-right: 1px solid #ccc;
      overflow-y: auto;
      transition: transform 0.3s ease;
    }

    aside.collapsed {
      transform: translateX(-100%);
    }

    main {
      padding: 20px;
      overflow-y: auto;
    }

    h1 { margin-top: 0; }

    .filter-group { margin-bottom: 20px; }
    label { display: block; margin-bottom: 5px; font-weight: 600; }
    select, input[type="text"] { width: 100%; padding: 5px; margin-bottom: 10px; }

    #breadcrumbs {
      font-size: 0.9em;
      margin-bottom: 15px;
      color: #555;
    }

    #breadcrumbs span {
      cursor: pointer;
      color: #0066cc;
    }

    #breadcrumbs span:hover {
      text-decoration: underline;
    }

    .record {
      border-bottom: 1px solid #ddd;
      margin-bottom: 20px;
      padding-bottom: 15px;
    }

    .record-title {
      font-weight: 700;
      font-size: 1.1em;
      margin-bottom: 5px;
      color: #222;
    }

    .record-content {
      font-size: 0.95em;
      color: #444;
      line-height: 1.5;
    }

    .record:last-child { border-bottom: none; }

    /* Mobile hamburger */
    #toggleSidebar {
      display: none;
      position: fixed;
      top: 10px;
      left: 10px;
      background: #0066cc;
      color: white;
      border: none;
      padding: 8px 12px;
      z-index: 1000;
      cursor: pointer;
      border-radius: 4px;
    }

    @media (max-width: 768px) {
      body { grid-template-columns: 1fr; }
      aside { position: fixed; top: 0; left: 0; bottom: 0; width: 240px; z-index: 999; }
      #toggleSidebar { display: block; }
    }
  </style>
</head>
<body>

  <button id="toggleSidebar">☰ Filters</button>

  <aside>
    <h2>Filter</h2>
    <div id="filterContainer"></div>
  </aside>

  <main>
    <h1>Paul Stein Notes</h1>
    <div id="breadcrumbs">Home</div>
    <input type="text" id="keywordSearch" placeholder="Search Title and Content..." />
    <div id="recordsContainer"></div>
  </main>

let records = [];
let currentFilters = { year: null, season: null, week: null, date: null };

// Load CSV
Papa.parse('data/lectionary.csv', {
  download: true,
  header: true,
  complete: function(results) {
    records = results.data;
    populateFilters(records);
    showDefaultWeek();
  }
});

function populateFilters(data) {
  const years = [...new Set(data.map(d => d.year))];
  const seasons = [...new Set(data.map(d => d.season))];
  const weeks = [...new Set(data.map(d => d.week))];

  fillSelect('#yearFilter', years);
  fillSelect('#seasonFilter', seasons);
  fillSelect('#weekFilter', weeks);
}

function fillSelect(selector, values) {
  const select = document.querySelector(selector);
  select.innerHTML = '<option value="">All</option>' + 
    values.map(v => `<option value="${v}">${v}</option>`).join('');
}

// ----------  DATE SELECTION  ----------
document.querySelector('#dateFilter').addEventListener('change', function() {
  const selectedDate = this.value;
  const matched = records.find(r => r.date === selectedDate);
  if (matched) updateFiltersFromRecord(matched);
});

function updateFiltersFromRecord(record) {
  currentFilters = {
    year: record.year,
    season: record.season,
    week: record.week,
    date: record.date
  };
  document.querySelector('#yearFilter').value = record.year;
  document.querySelector('#seasonFilter').value = record.season;
  document.querySelector('#weekFilter').value = record.week;
  document.querySelector('#dateFilter').value = record.date;
  renderContent(record);
  updateBreadcrumbs(record);
}

// ----------  OTHER FILTERS  ----------
['#yearFilter','#seasonFilter','#weekFilter'].forEach(sel => {
  document.querySelector(sel).addEventListener('change', function() {
    const year = document.querySelector('#yearFilter').value;
    const season = document.querySelector('#seasonFilter').value;
    const week = document.querySelector('#weekFilter').value;
    const matched = records.find(r =>
      r.year === year && r.season === season && r.week === week
    );
    if (matched) updateFiltersFromRecord(matched);
  });
});

// ----------  DEFAULT WEEK ON PAGE LOAD ----------
function showDefaultWeek() {
  const today = new Date().toISOString().split('T')[0];
  const record = records.find(r => r.date <= today) || records[0];
  updateFiltersFromRecord(record);
}

// ----------  RENDER CONTENT ----------
function renderContent(item) {
  const main = document.querySelector('#main-content');
  main.innerHTML = `
    <h2>${item.gospel_title || ''}</h2>
    <p><em>${item.date} • ${item.season} Week ${item.week}, Year ${item.year}</em></p>

    ${item.gospel_content ? `
      <section class="gospel">
        <h3>${item.gospel_title}</h3>
        <p class="author">by ${item.gospel_author}</p>
        <p>${item.gospel_content}</p>
      </section>
    ` : ''}

    ${item.commentary_content ? `
      <section class="commentary">
        <h3>${item.commentary_title}</h3>
        <p class="author">by ${item.commentary_author}</p>
        <p>${item.commentary_content}</p>
      </section>
    ` : ''}

    ${item.reflection_content ? `
      <section class="reflection">
        <h3>${item.reflection_title}</h3>
        <p class="author">by ${item.reflection_author}</p>
        <p>${item.reflection_content}</p>
      </section>
    ` : ''}
  `;
}

// ----------  BREADCRUMBS ----------
function updateBreadcrumbs(record) {
  const breadcrumb = document.querySelector('#breadcrumbs');
  breadcrumb.innerHTML = `
    <a href="#" onclick="filterBy('year','${record.year}')">${record.year}</a> ›
    <a href="#" onclick="filterBy('season','${record.season}')">${record.season}</a> ›
    <a href="#" onclick="filterBy('week','${record.week}')">Week ${record.week}</a>
  `;
}

function filterBy(field, value) {
  const matched = records.find(r => r[field] === value);
  if (matched) updateFiltersFromRecord(matched);
}

</body>
</html>
